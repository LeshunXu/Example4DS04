---
title: "Designs for experiments"
author: "by Leshun Xu"
date: "27 Apr 2019"
output:
  html_document: 
published: no
status: processed
tags: R forecast
draft: no
---

Historically, the agricultural experimentation is the earliest application area on Design of Experiments.
This document is an example on how designs affect experiments. It includes a method on weighing products with a better precision, a test on whether the nitrogen fertilizer affects the crops, and an A/B testing for two strategies.
Currently, there are many packages can be found in RCAN. However, in this example, only "pwr" package is used for A/B testing. For more details of other packages, please refer to
[CRAN Task View: Design of Experiments (DoE) & Analysis of Experimental Data](https://cran.r-project.org/web/views/ExperimentalDesign.html)
and
[Design of Experiments in R](https://www.r-project.org/conferences/useR-2011/TalkSlides/Invited/Gromping-Design_of_Experiments.pdf)
(the invited talk at [The R User Conference 2011](https://www.r-project.org/conferences/useR-2011/)) by [Ulrike Groemping](https://prof.beuth-hochschule.de/groemping/?L=1).


```{r setup, include=FALSE}
# library(data.table)
# library(mgcv)
# library(ggplot2)
suppressMessages(library(pwr, warn.conflicts = FALSE))
# library(dplyr)
# library(scales)
```

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
# setwd("D:/2019 Example4DataScience/Example4DS04")
opts_knit$set(root.dir = "D:/2019 Example4DataScience/Example4DS02")
```
```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

```

## Weighing three balls by using a newly-designed balance

The "balls" here can be livestocks, crops, and any other products in industries. The goal is to weight them with a smaller variation, which means a better precision. This idea is inspired by the example on
[Wikipedia](https://en.wikipedia.org/wiki/Design_of_experiments) website.

Let's suppose the variance of measures is $\sigma^2$ (of cause, in i.i.d. situations). If we use the balance as in Figure 1, and we weight one object (i.e. one ball) at each time, then the varance is certainly $\sigma^2$.

<center>

![Figure 1: The balance ([Refer to Wikipedia](https://en.wikipedia.org/wiki/Design_of_experiments#/media/File:Balance_%C3%A0_tabac_1850.JPG))](Balance1.JPG)

</center>

If we use the design introduced in [Wikipedia](https://en.wikipedia.org/wiki/Design_of_experiments) (i.e. let $B_i, (i=1,2,3)$ stand for three balls, and $Y_j, j=1, 2, 3, 4,$ are measued differences described in the following table), then the weight of each ball can be estimated in the following formulas:

Steps | Left Pan | Right Pan | Measured Difference
---------|------|---------|------
step 1 | $B_1$,  $B_2$,  $B_3$| empty | $Y_1= (B_1+B_2+B_3)-0$
step 2 | $B_1$, $B_3$ | $B_2$ | $Y_2= (B_1+B_3) - B_2$
step 3 | $B_2$, $B_3$ | $B_1$ | $Y_2= (B_2+B_3) - B_1$
step 4 | $B_1$, $B_2$ | $B_3$ | $Y_2= (B_1+B_2) - B_3$


$$
\mbox{estimated weight of }B_1=\frac{Y_1+Y_2-Y_3+Y_4}{4},
$$
$$
\mbox{estimated weight of }B_2=\frac{Y_1-Y_2+Y_3+Y_4}{4},
$$
$$
\mbox{estimated weight of }B_3=\frac{Y_1+Y_2+Y_3-Y_4}{4}.
$$
Now, since measures are i.i.d., the variance of the estimation becomes $\sigma^2/4$, which implies a higher precision.

However, this design is hard for use in practice when the number of objects is greater, when the objects are hard to be measure more than once, or when the balance limitation is surpassed. Therefore, I suggest the following newly-designed balance.

<center>

![Figure 2: The newly-designed balance (Art work by Sophia)](Balance2.JPG)

</center>

Let's suppose the "left arm" is $k$ times as the length of the "right arm" of this new balance. Then it gives us $k^2$ times as much precision for the estimate of using the old balance.


## Nitrogen fertilizer for corns.

This example is from the book *Experimental Design and Analysis* by [Howard J. Seltman](http://www.stat.cmu.edu/people/faculty/howard-seltman). The goal is to evaluate whether the nitrogen fertilizer benefits the weights of corns.

We assume the effects of nitrogen fertilizer is linear to the corn weights, i.e. $\mathbb{E}(weight| nitrogen)=\beta_0+\beta_1nitrogen$. Then the statistical hypotheses are


H0 : $\beta_1 = 0$.

H1 : $\beta_1 \neq 0$.

By using the simple linear regression, we have the following summary of the fitted model.
```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
corns <- read.table("D:/2019 Example4DataScience/Example4DS04/corn.dat", header = TRUE)
m1 <- lm(weight~nitrogen, data = corns)
summary(m1)
```

It means $\beta_1$ is estimated by `r round(as.numeric(m1$coefficients[2]),4)`, while the nitrogen fertilizer significantly and positively contributes to the weight of corns. Therefore, the funtion of nitrogen fertlizer can not be ignored (reject H0) by farmers.


## R package "pwr" for A/B testing

Repeatedly, we assume there are two strategies for planting corns, Strategy A using nitrogen fertilizer, and Strategy B not using nitrogen fertilizer. Let's suppose 1000 farming plots were measured, and 100 of them were found gained weight as conversions. Details are listed in the following table:

Strategies | Number of plots | Conversions |
---------|------|---------|------
A | 520 | 62 |
B | 480 | 38 |

The statistical hypotheses are:

H0: there is **no** difference between Strategy A and Strategy B.

H1: there **exits** a difference between Strategy A and Strategy B.

Since the difference between two strategies could be positive or negative, we will use the two-tail test in the following R function. 
 
```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
prop.test(c(62, 38), c(520,480))

```

As we can see, the p-value is 0.045. It means under the 5% significant level, we can reject the hypothesis that conversion rates are equal, and take for Strategy B has a better harvest


This "pwr" package can also provide recommendations for the sample size.
If we already have 520 sample for Strategy A, and we hope the Type I error is less than 5%, the Type II error is less than 15%, and the effect size is assumed 0.2 in the following R function.


```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
pwr.2p2n.test(h=0.2, n1=520, sig.level=0.05, power=0.85)
```

Then the suggested sample size for Strategy B is at least 395.


